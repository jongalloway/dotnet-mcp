name: Release Scenario Tests (Manual)

on:
    workflow_dispatch:
        inputs:
            os:
                description: "Runner OS (ubuntu-latest, windows-latest, or all)"
                required: false
                default: "ubuntu-latest"

jobs:
    release-scenarios:
        name: Release scenarios (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        timeout-minutes: 60
        permissions:
            contents: read

        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest]

        if: ${{ inputs.os == 'all' || inputs.os == matrix.os }}

        env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
            DOTNET_CLI_TELEMETRY_OPTOUT: "1"
            DOTNET_NOLOGO: "1"
            DOTNET_MCP_RELEASE_SCENARIO_TESTS: "1"

        steps:
            - uses: actions/checkout@v6

            - name: Setup .NET
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: "10.0.x"

            - name: Display .NET info
              run: dotnet --info

            - name: Restore dependencies
              run: dotnet restore DotNetMcp.slnx

            - name: Build
              run: dotnet build DotNetMcp.slnx --no-restore --configuration Release

            - name: Validate server.json
              run: pwsh -File scripts/validate-server-json.ps1

            - name: Run Release Scenario Tests
              run: dotnet test --project DotNetMcp.Tests/DotNetMcp.Tests.csproj --no-build --configuration Release --verbosity normal -- --filter-namespace "*DotNetMcp.Tests.ReleaseScenarios*"
