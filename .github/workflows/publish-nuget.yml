name: Publish NuGet Package

env:
  PACKAGE_ID: Community.Mcp.DotNet

on:
  push:
    tags:
      - "v*" # Only runs on version tags like v1.0.0, v0.1.0-alpha.1
  workflow_dispatch: # Allows manual triggering from GitHub Actions UI

jobs:
  publish:
    runs-on: ubuntu-latest
    outputs:
      package_id: ${{ steps.package.outputs.package_id }}
      version: ${{ steps.package.outputs.version }}
    permissions:
      contents: read
      id-token: write # Required for OIDC token issuance (Trusted Publishing)

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Required for MinVer to access Git history and tags

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          cache: true
          cache-dependency-path: "**/*.csproj"

      - name: Restore dependencies
        run: dotnet restore DotNetMcp/DotNetMcp.csproj

      - name: Build
        run: dotnet build DotNetMcp/DotNetMcp.csproj --configuration Release --no-restore

      - name: Pack
        run: dotnet pack DotNetMcp/DotNetMcp.csproj --configuration Release --no-build --output ./artifacts

      - name: Detect package artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          nupkg=$(ls -1 ./artifacts/*.nupkg | head -n 1)
          if [ -z "${nupkg:-}" ] || [ ! -f "$nupkg" ]; then
            echo "‚ùå ERROR: No .nupkg found in ./artifacts"
            ls -la ./artifacts || true
            exit 1
          fi

          filename=$(basename "$nupkg")
          package_id="${{ env.PACKAGE_ID }}"
          if [[ "$filename" != "$package_id".*.nupkg ]]; then
            echo "‚ùå ERROR: Unexpected package file name: $filename"
            echo "Expected prefix: ${package_id}.<version>.nupkg"
            exit 1
          fi

          version="${filename#${package_id}.}"
          version="${version%.nupkg}"

          echo "Package: $nupkg"
          echo "Package ID: $package_id"
          echo "Version: $version"

          echo "nupkg=$nupkg" >> "$GITHUB_OUTPUT"
          echo "package_id=$package_id" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Validate server.json in package
        run: |
          echo "üìã Validating server.json in package..."
          for package in ./artifacts/*.nupkg; do
            echo "Package: $(basename "$package")"
            
            # Extract server.json
            unzip -p "$package" ".mcp/server.json" > /tmp/server.json
            
            # Display content
            echo "Content:"
            cat /tmp/server.json | jq '.'
            echo ""
            
            # Validate with PowerShell script
            echo "Running validation..."
            pwsh -File scripts/validate-server-json.ps1 -ServerJsonPath /tmp/server.json
            
            if [ $? -ne 0 ]; then
              echo "‚ùå ERROR: server.json validation failed!"
              exit 1
            fi
            echo ""
          done

      - name: Debug - Show package details
        run: |
          echo "?? Packages to be published:"
          ls -lh ./artifacts/*.nupkg
          echo ""
          echo "?? Package metadata:"
          for package in ./artifacts/*.nupkg; do
            unzip -p "$package" *.nuspec | head -20 || true
          done

      - name: Debug - Verify workflow context
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"

      - name: NuGet login (OIDC ? temp API key)
        uses: NuGet/login@v1
        id: nuget_login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Debug - Verify API key received
        run: |
          if [ -z "${{ steps.nuget_login.outputs.NUGET_API_KEY }}" ]; then
            echo "? ERROR: NUGET_API_KEY is empty!"
            echo "This means the OIDC token exchange failed."
            echo "Check your Trusted Publishing policy on nuget.org"
            exit 1
          else
            KEY="${{ steps.nuget_login.outputs.NUGET_API_KEY }}"
            echo "? API key received successfully (length: ${#KEY} characters)"
          fi

      - name: Check existing package on NuGet.org
        continue-on-error: true
        run: |
          echo "?? Checking if package versions already exist on NuGet.org..."
          for package in ./artifacts/*.nupkg; do
            FILENAME=$(basename "$package")
            PACKAGE_ID=$(echo "$FILENAME" | sed -E 's/\.[0-9]+\.[0-9]+\.[0-9]+.*\.nupkg$//')
            VERSION=$(echo "$FILENAME" | sed -E "s/${PACKAGE_ID}\.([0-9]+\.[0-9]+\.[0-9]+.*?)\.nupkg$/\1/")
            
            echo "Package ID: $PACKAGE_ID"
            echo "Version: $VERSION"
            
            # Check if package exists via NuGet API
            API_URL="https://api.nuget.org/v3-flatcontainer/${PACKAGE_ID,,}/$VERSION/${PACKAGE_ID,,}.$VERSION.nupkg"
            echo "Checking: $API_URL"
            
            if curl -s -f -I "$API_URL" > /dev/null 2>&1; then
              echo "??  Version $VERSION already exists on NuGet.org"
              echo "View at: https://www.nuget.org/packages/$PACKAGE_ID/$VERSION"
            else
              echo "? Version $VERSION not found - ready to publish"
            fi
            echo "---"
          done

      - name: Push to NuGet
        run: |
          SUCCESS=0
          SKIPPED=0
          FAILED=0

          for package in ./artifacts/*.nupkg; do
            echo "?? Pushing $(basename "$package")..."
            
            if dotnet nuget push "$package" \
              --source https://api.nuget.org/v3/index.json \
              --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} \
              --skip-duplicate 2>&1 | tee push.log; then
              echo "? Successfully pushed"
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              if grep -q "already exists" push.log || grep -q "Conflict" push.log; then
                echo "??  Package already exists (skipped)"
                echo "If you can't see it on NuGet.org, it may be:"
                echo "  1. Unlisted - check https://www.nuget.org/account/Packages"
                echo "  2. Still being validated (wait a few minutes)"
                echo "  3. Use lowercase URL: https://www.nuget.org/packages/Community.Mcp.DotNet"
                SKIPPED=$((SKIPPED + 1))
              else
                echo "? Failed to push package (exit code: $EXIT_CODE)"
                FAILED=$((FAILED + 1))
              fi
            fi
            echo ""
          done

          echo "?? Summary: $SUCCESS succeeded, $SKIPPED skipped, $FAILED failed"

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi

          echo "‚úÖ NuGet push completed"

      - name: Upload package artifact (for registry publish)
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-mcp-nupkg
          path: ./artifacts/*.nupkg

  publish-registry:
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for GitHub OIDC login (mcp-publisher)

    concurrency:
      group: "publish-mcp-registry-${{ github.repository }}-${{ github.ref }}"
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-mcp-nupkg
          path: ./artifacts

      - name: Extract server.json from package
        shell: bash
        run: |
          set -euo pipefail

          # First, verify the artifact was downloaded
          nupkg=$(ls -1 ./artifacts/*.nupkg | head -n 1)
          if [ -z "${nupkg:-}" ] || [ ! -f "$nupkg" ]; then
            echo "‚ùå ERROR: No .nupkg found in ./artifacts"
            ls -la ./artifacts || true
            exit 1
          fi

          # Then validate we received the package metadata from the publish job
          package_id="${{ needs.publish.outputs.package_id }}"
          version="${{ needs.publish.outputs.version }}"

          if [ -z "${package_id:-}" ] || [ -z "${version:-}" ]; then
            echo "‚ùå ERROR: Package ID or version not provided by publish job"
            echo "Package ID: ${package_id:-<empty>}"
            echo "Version: ${version:-<empty>}"
            exit 1
          fi

          echo "Package: $nupkg"
          echo "Package ID: $package_id"
          echo "Version: $version"

          if ! unzip -p "$nupkg" ".mcp/server.json" > /tmp/server.json; then
            echo "‚ùå ERROR: Failed to extract .mcp/server.json from package"
            exit 1
          fi

          if [ ! -s /tmp/server.json ]; then
            echo "‚ùå ERROR: Extracted server.json is empty"
            exit 1
          fi

          cp /tmp/server.json ./server.json

      - name: Install MCP Publisher
        shell: bash
        run: |
          set -euo pipefail
          os="$(uname -s | tr '[:upper:]' '[:lower:]')"
          arch="$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')"
          url="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${os}_${arch}.tar.gz"

          echo "Downloading mcp-publisher from: ${url}"
          curl -fsSL "${url}" -o mcp-publisher.tar.gz

          # Verify checksum if provided
          if [ -n "${MCP_PUBLISHER_SHA256:-}" ]; then
            echo "Verifying checksum for mcp-publisher.tar.gz"
            echo "${MCP_PUBLISHER_SHA256}  mcp-publisher.tar.gz" | sha256sum -c -
          else
            echo "‚ö†Ô∏è  WARNING: MCP_PUBLISHER_SHA256 environment variable is not set. Skipping checksum verification."
            echo "For enhanced security, consider setting this variable with the expected SHA256 checksum."
          fi

          tar xzf mcp-publisher.tar.gz mcp-publisher
          chmod +x mcp-publisher
          ./mcp-publisher --version

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry (with retry)
        shell: bash
        run: |
          set -euo pipefail

          # Retry configuration: 8 attempts with exponential backoff starting at 15s, capped at 180s.
          # With this configuration, worst-case total wait time is ~12.75 minutes (~765 seconds).
          # This window gives the MCP registry enough time to observe the newly published
          # NuGet package while keeping the workflow bounded.
          max_attempts=8
          sleep_seconds=15
          max_sleep_seconds=180

          for attempt in $(seq 1 $max_attempts); do
            echo "Attempt $attempt/$max_attempts to publish to MCP registry"

            set +e
            ./mcp-publisher publish 2>&1 | tee publish.log
            exit_code=${PIPESTATUS[0]}
            set -e

            if [ "$exit_code" -eq 0 ]; then
              echo "‚úÖ MCP registry publish succeeded"
              exit 0
            fi

            # Retry only for known eventual-consistency style errors from the MCP registry.
            # Match multiple common phrasings in a case-insensitive way to avoid relying on a single exact string.
            if grep -Ei '(exists but version|version.*not.*available|eventual consistency|propagate|propagation delay)' publish.log; then
              if [ "$attempt" -lt "$max_attempts" ]; then
                echo "‚ö†Ô∏è  Registry cannot see NuGet version yet; retrying after ${sleep_seconds}s"
                sleep "$sleep_seconds"
                # Apply exponential backoff with cap
                sleep_seconds=$(( sleep_seconds * 2 ))
                if [ "$sleep_seconds" -gt "$max_sleep_seconds" ]; then
                  sleep_seconds="$max_sleep_seconds"
                fi
                continue
              else
                echo "‚ö†Ô∏è  Registry cannot see NuGet version yet; no retries remaining, failing without additional delay"
                exit 1
              fi
            fi

            echo "‚ùå Publish failed with non-retryable error"
            exit "$exit_code"
          done
