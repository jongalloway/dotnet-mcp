name: Publish NuGet Package

env:
  PACKAGE_ID: Community.Mcp.DotNet

on:
  push:
    tags:
      - "v*" # Only runs on version tags like v1.0.0, v0.1.0-alpha.1
  workflow_dispatch: # Allows manual triggering from GitHub Actions UI

jobs:
  publish:
    runs-on: ubuntu-latest
    outputs:
      package_id: ${{ steps.package.outputs.package_id }}
      version: ${{ steps.package.outputs.version }}
    permissions:
      contents: read
      id-token: write # Required for OIDC token issuance (Trusted Publishing)

    steps:
      - uses: actions/checkout@v6
        id: checkout
        with:
          fetch-depth: 0 # Required for MinVer to access Git history and tags

      - name: Validate ref for manual runs
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          echo "‚ùå This workflow should be run on a version tag (refs/tags/v*)."
          echo "You triggered it on: ${{ github.ref }}"
          echo "Re-run and select the release tag (e.g., v1.0.0) as the ref."
          exit 1

      - name: Ensure NuGet cache folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.nuget/packages"

      - name: Setup .NET
        id: setup_dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          cache: true
          cache-dependency-path: "**/*.csproj"

      - name: Restore dependencies
        id: restore
        run: dotnet restore DotNetMcp/DotNetMcp.csproj

      - name: Build
        id: build
        run: dotnet build DotNetMcp/DotNetMcp.csproj --configuration Release --no-restore

      - name: Pack
        id: pack
        run: dotnet pack DotNetMcp/DotNetMcp.csproj --configuration Release --no-build --output ./artifacts

      - name: Detect package artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          nupkg=$(ls -1 ./artifacts/*.nupkg | head -n 1)
          if [ -z "${nupkg:-}" ] || [ ! -f "$nupkg" ]; then
            echo "‚ùå ERROR: No .nupkg found in ./artifacts"
            ls -la ./artifacts || true
            exit 1
          fi

          filename=$(basename "$nupkg")
          package_id="${{ env.PACKAGE_ID }}"

          # Validate filename matches package ID with semantic version format
          # Semantic versioning: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
          # - Prerelease and build metadata use alphanumeric identifiers separated by dots
          # - Identifiers must start/end with alphanumeric chars (no leading/trailing hyphens)
          # - Hyphens only allowed between alphanumeric characters
          escaped_package_id=${package_id//./\\.}
          identifier="[0-9A-Za-z]+(-[0-9A-Za-z]+)*"
          semver_regex="^${escaped_package_id}\.[0-9]+\.[0-9]+\.[0-9]+(-${identifier}(\.${identifier})*)?(\+${identifier}(\.${identifier})*)?\.nupkg$"
          if [[ ! "$filename" =~ $semver_regex ]]; then
            echo "‚ùå ERROR: Unexpected package file name: $filename"
            echo "Expected format: ${package_id}.<semantic-version>.nupkg (e.g., ${package_id}.1.0.0.nupkg)"
            exit 1
          fi

          version="${filename#${package_id}.}"
          version="${version%.nupkg}"

          echo "Package: $nupkg"
          echo "Package ID: $package_id"
          echo "Version: $version"

          echo "nupkg=$nupkg" >> "$GITHUB_OUTPUT"
          echo "package_id=$package_id" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Validate server.json in package
        id: validate_server_json
        run: |
          echo "üìã Validating server.json in package..."
          for package in ./artifacts/*.nupkg; do
            echo "Package: $(basename "$package")"
            
            # Extract server.json
            unzip -p "$package" ".mcp/server.json" > /tmp/server.json
            
            # Display content
            echo "Content:"
            cat /tmp/server.json | jq '.'
            echo ""
            
            # Validate with PowerShell script
            echo "Running validation..."
            pwsh -File scripts/validate-server-json.ps1 -ServerJsonPath /tmp/server.json
            
            if [ $? -ne 0 ]; then
              echo "‚ùå ERROR: server.json validation failed!"
              exit 1
            fi
            echo ""
          done

      - name: Debug - Show package details
        run: |
          echo "?? Packages to be published:"
          ls -lh ./artifacts/*.nupkg
          echo ""
          echo "?? Package metadata:"
          for package in ./artifacts/*.nupkg; do
            unzip -p "$package" *.nuspec | head -20 || true
          done

      - name: Debug - Verify workflow context
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"

      - name: NuGet login (OIDC ? temp API key)
        id: nuget_login
        uses: NuGet/login@v1
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Debug - Verify API key received
        run: |
          if [ -z "${{ steps.nuget_login.outputs.NUGET_API_KEY }}" ]; then
            echo "? ERROR: NUGET_API_KEY is empty!"
            echo "This means the OIDC token exchange failed."
            echo "Check your Trusted Publishing policy on nuget.org"
            exit 1
          else
            KEY="${{ steps.nuget_login.outputs.NUGET_API_KEY }}"
            echo "? API key received successfully (length: ${#KEY} characters)"
          fi

      - name: Check existing package on NuGet.org
        continue-on-error: true
        run: |
          echo "?? Checking if package versions already exist on NuGet.org..."
          for package in ./artifacts/*.nupkg; do
            FILENAME=$(basename "$package")
            PACKAGE_ID=$(echo "$FILENAME" | sed -E 's/\.[0-9]+\.[0-9]+\.[0-9]+.*\.nupkg$//')
            VERSION=$(echo "$FILENAME" | sed -E "s/${PACKAGE_ID}\.([0-9]+\.[0-9]+\.[0-9]+.*?)\.nupkg$/\1/")
            
            echo "Package ID: $PACKAGE_ID"
            echo "Version: $VERSION"
            
            # Check if package exists via NuGet API
            API_URL="https://api.nuget.org/v3-flatcontainer/${PACKAGE_ID,,}/$VERSION/${PACKAGE_ID,,}.$VERSION.nupkg"
            echo "Checking: $API_URL"
            
            if curl -s -f -I "$API_URL" > /dev/null 2>&1; then
              echo "??  Version $VERSION already exists on NuGet.org"
              echo "View at: https://www.nuget.org/packages/$PACKAGE_ID/$VERSION"
            else
              echo "? Version $VERSION not found - ready to publish"
            fi
            echo "---"
          done

      - name: Push to NuGet
        id: push_nuget
        run: |
          SUCCESS=0
          SKIPPED=0
          FAILED=0

          for package in ./artifacts/*.nupkg; do
            echo "?? Pushing $(basename "$package")..."
            
            if dotnet nuget push "$package" \
              --source https://api.nuget.org/v3/index.json \
              --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} \
              --skip-duplicate 2>&1 | tee push.log; then
              echo "? Successfully pushed"
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              if grep -q "already exists" push.log || grep -q "Conflict" push.log; then
                echo "??  Package already exists (skipped)"
                echo "If you can't see it on NuGet.org, it may be:"
                echo "  1. Unlisted - check https://www.nuget.org/account/Packages"
                echo "  2. Still being validated (wait a few minutes)"
                echo "  3. Use lowercase URL: https://www.nuget.org/packages/Community.Mcp.DotNet"
                SKIPPED=$((SKIPPED + 1))
              else
                echo "? Failed to push package (exit code: $EXIT_CODE)"
                FAILED=$((FAILED + 1))
              fi
            fi
            echo ""
          done

          echo "?? Summary: $SUCCESS succeeded, $SKIPPED skipped, $FAILED failed"

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi

          echo "‚úÖ NuGet push completed"

      - name: Upload package artifact (for registry publish)
        id: upload_nupkg_artifact
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-mcp-nupkg
          path: ./artifacts/*.nupkg

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          {
            echo "## NuGet publish summary"
            echo ""
            echo "- Package: \`${{ steps.package.outputs.package_id }}\` \`${{ steps.package.outputs.version }}\`"
            echo "- Ref: \`${{ github.ref }}\`"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo ""
            echo "### Step outcomes"
            echo "| Step | Outcome |"
            echo "| --- | --- |"
            echo "| Checkout | ${{ steps.checkout.outcome }} |"
            echo "| Setup .NET | ${{ steps.setup_dotnet.outcome }} |"
            echo "| Restore | ${{ steps.restore.outcome }} |"
            echo "| Build | ${{ steps.build.outcome }} |"
            echo "| Pack | ${{ steps.pack.outcome }} |"
            echo "| Detect package | ${{ steps.package.outcome }} |"
            echo "| Validate server.json | ${{ steps.validate_server_json.outcome }} |"
            echo "| NuGet login | ${{ steps.nuget_login.outcome }} |"
            echo "| Push to NuGet | ${{ steps.push_nuget.outcome }} |"
            echo "| Upload nupkg artifact | ${{ steps.upload_nupkg_artifact.outcome }} |"
            echo ""
            echo "### Artifacts"
            echo "- dotnet-mcp-nupkg"
          } >> "${GITHUB_STEP_SUMMARY}"

  publish-registry:
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for GitHub OIDC login (mcp-publisher)

    concurrency:
      group: "publish-mcp-registry-${{ github.repository }}-${{ github.ref }}"
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download package artifact
        id: download_nupkg
        uses: actions/download-artifact@v7
        with:
          name: dotnet-mcp-nupkg
          path: ./artifacts

      - name: Extract server.json from package
        id: extract_server_json
        shell: bash
        run: |
          set -euo pipefail

          # First, verify the artifact was downloaded
          nupkg=$(ls -1 ./artifacts/*.nupkg | head -n 1)
          if [ -z "${nupkg:-}" ] || [ ! -f "$nupkg" ]; then
            echo "‚ùå ERROR: No .nupkg found in ./artifacts"
            ls -la ./artifacts || true
            exit 1
          fi

          # Then validate we received the package metadata from the publish job
          package_id="${{ needs.publish.outputs.package_id }}"
          version="${{ needs.publish.outputs.version }}"

          if [ -z "${package_id:-}" ] || [ -z "${version:-}" ]; then
            echo "‚ùå ERROR: Package ID or version not provided by publish job"
            echo "Package ID: ${package_id:-<empty>}"
            echo "Version: ${version:-<empty>}"
            exit 1
          fi

          echo "Package: $nupkg"
          echo "Package ID: $package_id"
          echo "Version: $version"

          if ! unzip -p "$nupkg" ".mcp/server.json" > /tmp/server.json; then
            echo "‚ùå ERROR: Failed to extract .mcp/server.json from package"
            exit 1
          fi

          if [ ! -s /tmp/server.json ]; then
            echo "‚ùå ERROR: Extracted server.json is empty"
            exit 1
          fi

          cp /tmp/server.json ./server.json

      - name: Install MCP Publisher
        id: install_publisher
        uses: ./.github/actions/install-mcp-publisher
        with:
          checksum: ${{ env.MCP_PUBLISHER_SHA256 }}

      - name: Publish to MCP Registry
        id: publish_registry
        uses: ./.github/actions/publish-mcp-registry

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          {
            echo "## MCP Registry publish summary (from NuGet publish workflow)"
            echo ""
            echo "- Package: \`${{ needs.publish.outputs.package_id }}\` \`${{ needs.publish.outputs.version }}\`"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo ""
            echo "### Step outcomes"
            echo "| Step | Outcome |"
            echo "| --- | --- |"
            echo "| Checkout | ${{ steps.checkout.outcome }} |"
            echo "| Download nupkg artifact | ${{ steps.download_nupkg.outcome }} |"
            echo "| Extract server.json | ${{ steps.extract_server_json.outcome }} |"
            echo "| Install publisher | ${{ steps.install_publisher.outcome }} |"
            echo "| Publish registry | ${{ steps.publish_registry.outcome }} |"
            echo ""
            echo "### Artifacts"
            echo "- dotnet-mcp-nupkg (input)"
          } >> "${GITHUB_STEP_SUMMARY}"
