name: Publish MCP Registry

env:
    PACKAGE_ID: Community.Mcp.DotNet

on:
    workflow_run:
        # IMPORTANT: This must match the `name:` of the NuGet publish workflow in publish-nuget.yml.
        # If that workflow is renamed, update this list to keep the trigger working.
        workflows: ["Publish NuGet Package"]
        types:
            - completed
    workflow_dispatch:
        inputs:
            packageVersion:
                description: "NuGet package version to publish (optional; defaults to tag version if available)"
                required: false
                type: string

jobs:
    publish-registry:
        # Only run automatically if the NuGet publish workflow succeeded
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write # Required for GitHub OIDC login (mcp-publisher)

        concurrency:
            group: publish-mcp-registry-${{ github.repository }}-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
            cancel-in-progress: false

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  # For workflow_run, check out the exact commit that was published to NuGet.
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

            - name: Prepare package (wait, download, extract server.json)
              id: prepare
              shell: bash
              run: |
                  set -euo pipefail

                  package_id='${{ env.PACKAGE_ID }}'
                  if [ -z "${package_id:-}" ]; then
                    echo "❌ ERROR: PACKAGE_ID env var is empty"
                    exit 1
                  fi

                  # 1) Determine version from workflow input or git tag
                  input_version='${{ inputs.packageVersion }}'
                  if [ -n "${input_version:-}" ]; then
                    version="$input_version"
                  else
                    tag=$(git tag --points-at HEAD | grep '^v' | sort -V | tail -n 1 || true)
                    if [ -z "${tag:-}" ]; then
                      if [ "${GITHUB_EVENT_NAME:-}" = "workflow_dispatch" ]; then
                        echo "❌ ERROR: No v* tag found on the checked-out commit (${GITHUB_SHA:-})."
                        echo "When triggering this workflow manually you must either:"
                        echo "  - Provide the 'packageVersion' input, or"
                        echo "  - Trigger the workflow from a commit that has a v* tag."
                      else
                        echo "❌ ERROR: Could not determine version from a v* tag on this commit."
                        echo "Provide workflow_dispatch input 'packageVersion' to publish a specific version."
                      fi
                      exit 1
                    fi
                    version="${tag#v}"
                  fi

                  package_id_lc=$(echo "$package_id" | tr '[:upper:]' '[:lower:]')
                  url="https://api.nuget.org/v3-flatcontainer/${package_id_lc}/${version}/${package_id_lc}.${version}.nupkg"

                  echo "Package ID: $package_id"
                  echo "Version: $version"
                  echo "NuGet URL: $url"

                  # 2) Wait for NuGet to serve the version, then download
                  # Retry configuration: 12 attempts with exponential backoff starting at 10s, capped at 120s.
                  # This allows up to ~16.5 minutes total wait time for NuGet eventual consistency.
                  max_attempts=12
                  sleep_seconds=10
                  mkdir -p ./artifacts
                  out="./artifacts/${package_id}.${version}.nupkg"

                  for attempt in $(seq 1 $max_attempts); do
                    echo "Attempt $attempt/$max_attempts (sleep=${sleep_seconds}s)"

                    if curl -s -f -I "$url" > /dev/null 2>&1; then
                      echo "✅ NuGet is serving ${package_id} ${version}"
                      curl -fsSL "$url" -o "$out"
                      echo "✅ Downloaded to: $out"
                      break
                    fi

                    if [ "$attempt" -lt "$max_attempts" ]; then
                      echo "Not visible yet; waiting..."
                      sleep "$sleep_seconds"
                      sleep_seconds=$(( sleep_seconds * 2 ))
                      if [ "$sleep_seconds" -gt 120 ]; then
                        sleep_seconds=120
                      fi
                    else
                      echo "Not visible yet; no retries remaining"
                    fi
                  done

                  if [ ! -f "$out" ]; then
                    echo "❌ Timed out waiting for NuGet to serve the new version."
                    echo "This is usually eventual consistency; re-run this workflow in a few minutes."
                    exit 1
                  fi

                  # 3) Extract server.json (mcp-publisher expects it at repo root)
                  if ! unzip -p "$out" ".mcp/server.json" > /tmp/server.json; then
                    echo "❌ ERROR: Failed to extract .mcp/server.json from package"
                    exit 1
                  fi

                  if [ ! -s /tmp/server.json ]; then
                    echo "❌ ERROR: Extracted server.json is empty"
                    exit 1
                  fi

                  cp /tmp/server.json ./server.json

                  echo "package_id=$package_id" >> "$GITHUB_OUTPUT"
                  echo "package_id_lc=$package_id_lc" >> "$GITHUB_OUTPUT"
                  echo "version=$version" >> "$GITHUB_OUTPUT"
                  echo "package_path=$out" >> "$GITHUB_OUTPUT"

            - name: Install MCP Publisher
              shell: bash
              run: |
                  set -euo pipefail
                  curl -fsSL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
                  chmod +x mcp-publisher
                  ./mcp-publisher --version

            - name: Login to MCP Registry
              run: ./mcp-publisher login github-oidc

            - name: Publish to MCP Registry (with retry)
              shell: bash
              run: |
                  set -euo pipefail

                  # Retry configuration: 8 attempts with exponential backoff starting at 15s, capped at 180s.
                  # With this configuration, worst-case total wait time is roughly 13 minutes (~765 seconds).
                  # This window gives the MCP registry enough time to observe the newly published
                  # NuGet package while keeping the workflow bounded.
                  max_attempts=8
                  sleep_seconds=15
                  max_sleep_seconds=180

                  for attempt in $(seq 1 $max_attempts); do
                    echo "Attempt $attempt/$max_attempts to publish to MCP registry"

                    set +e
                    ./mcp-publisher publish 2>&1 | tee publish.log
                    exit_code=${PIPESTATUS[0]}
                    set -e

                    if [ "$exit_code" -eq 0 ]; then
                      echo "✅ MCP registry publish succeeded"
                      exit 0
                    fi

                    # Retry only for the known eventual-consistency error.
                    if grep -q "exists but version" publish.log; then
                      if [ "$attempt" -lt "$max_attempts" ]; then
                        echo "⚠️  Registry cannot see NuGet version yet; retrying after ${sleep_seconds}s"
                        sleep "$sleep_seconds"
                        # Apply exponential backoff with cap
                        sleep_seconds=$(( sleep_seconds * 2 ))
                        if [ "$sleep_seconds" -gt "$max_sleep_seconds" ]; then
                          sleep_seconds="$max_sleep_seconds"
                        fi
                        continue
                      else
                        echo "⚠️  Registry cannot see NuGet version yet; no retries remaining, failing without additional delay"
                      fi
                    fi

                    echo "❌ Publish failed with non-retryable error"
                    exit "$exit_code"
                  done

                  echo "❌ MCP registry publish did not succeed after retries"
                  exit 1

            - name: Cleanup root server.json
              if: always()
              shell: bash
              run: |
                  rm -f ./server.json
